[gd_scene load_steps=11 format=2]

[ext_resource path="res://Nodes/Effects/trail.gd" type="Script" id=1]
[ext_resource path="res://Nodes/Player/Weapons/Ranged/Missile.png" type="Texture2D" id=2]
[ext_resource path="res://Nodes/Effects/trail.png" type="Texture2D" id=3]
[ext_resource path="res://Nodes/Map/ZIndexer.tscn" type="PackedScene" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Area2D

const SPEED = 400

@onready var tip:= $tip

var player: Player
var dir: Vector2
var locked_enemy: Node2D
var homing: float
var hitted: bool

func _ready() -> void:
	Utils.play_sample(Utils.random_sound(\"res://SFX/Weapons/gun_grenade_launcher_shot\"), self)
	Utils.play_sample(preload(\"res://SFX/Weapons/ROCKET_Launch_Deep_Slow_mono.wav\"), self, true, 1.1)
	dir = Vector2.RIGHT.rotated(rotation)
	Player.init_weapon(self, self, Const.ItemIDs.ROCKET_LAUNCHER)

func set_player(p: Player):
	player = p

func _physics_process(delta: float) -> void:
	if locked_enemy:
		homing += delta
		var dir_to_enemy := global_position.direction_to(locked_enemy.global_position)
		if dir.dot(dir_to_enemy) < 0.95:
			dir = (dir + dir_to_enemy * min(homing, 1)).normalized()
			rotation = dir.angle()
		
		if homing > 0.5:
			locked_enemy = null
	
	var ray := Utils.game.map.pixel_map.rayCastQTDistance(tip.global_position, dir, SPEED * delta, Player.get_weapon_mask(get_meta(\"data\")))
	if ray:
		on_hit(true)
	else:
		var move=dir * SPEED * delta
		get_meta(\"data\").velocity = move
		global_position += move

func on_hit(ground := false):
	if hitted:
		return
	
	if get_meta(\"data\").get(\"hit_swarm\", false):
		hitted = true
		await get_tree().create_timer(0.05, false).timeout
	
	var explosion := Const.EXPLOSION.instantiate() as Node2D
	explosion.position = tip.global_position
	explosion.scale = Vector2.ONE * get_meta(\"data\").custom_explosion_power
	if not ground:
		explosion.durability_threshold = 1
	get_parent().call_deferred(\"add_child\", explosion)
	explosion.set_meta(\"Rocket\",true)
	queue_free()
"

[sub_resource type="RectangleShape2D" id=8]
extents = Vector2( 6, 1 )

[sub_resource type="Curve" id=6]
_data = [ Vector2( 0, 0 ), 0.0, 2.82822, 0, 0, Vector2( 1, 1 ), 0.148854, 0.0, 0, 0 ]

[sub_resource type="Gradient" id=7]
offsets = PackedFloat32Array( 0, 0.87057, 1 )
colors = PackedColorArray( 0, 0, 0, 0, 1.24003, 0.159848, 0, 1, 8, 1, 0.109804, 1 )

[sub_resource type="Curve" id=3]
_data = [ Vector2( 0.00759219, 1 ), 0.0, -1.13353, 0, 0, Vector2( 1, 0 ), 0.0137962, 0.0, 0, 0 ]

[sub_resource type="Gradient" id=5]
offsets = PackedFloat32Array( 0, 0.422188, 0.841294, 1 )
colors = PackedColorArray( 1, 1, 1, 0, 1, 1, 1, 0.380392, 0.705882, 0.709804, 0.662745, 0.482353, 1, 1, 1, 0.467734 )

[node name="Missile" type="Area2D"]
z_index = 900
z_as_relative = false
script = SubResource( 1 )

[node name="ZIndexer" parent="." instance=ExtResource( 4 )]
z_index = 900

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( 6, 0 )
shape = SubResource( 8 )

[node name="Smoketrail" type="Line2D" parent="."]
z_index = 900
z_as_relative = false
points = PackedVector2Array( -22.3797, -0.055273, -19.3537, -0.0800762, -16.7742, -0.104879, -7.15056, -0.0304699 )
width = 5.0
width_curve = SubResource( 6 )
gradient = SubResource( 7 )
texture = ExtResource( 3 )
texture_mode = 2
joint_mode = 2
begin_cap_mode = 2
end_cap_mode = 2
script = ExtResource( 1 )
max_points = 4
max_random = 0.1
min_distance = 15
fadeout_random = Vector2( 0.1, 0.3 )

[node name="ZIndexer2" parent="Smoketrail" instance=ExtResource( 4 )]
z_index = 900

[node name="Smoketrail2" type="Line2D" parent="."]
z_index = 900
z_as_relative = false
points = PackedVector2Array( -55.1098, -1.484, -29.6439, -0.922771, -15.6828, -1.17142, -5.04229, -0.0056667, -0.15731, 0.0393295 )
width = 70.0
width_curve = SubResource( 3 )
gradient = SubResource( 5 )
texture = ExtResource( 3 )
texture_mode = 2
begin_cap_mode = 2
end_cap_mode = 2
script = ExtResource( 1 )
max_points = 40
max_random = 0.1
min_distance = 20
fadeout_random = Vector2( 2.1, 4 )

[node name="ZIndexer3" parent="Smoketrail2" instance=ExtResource( 4 )]
z_index = 900

[node name="Sprite2D" type="Sprite2D" parent="."]
position = Vector2( 8, 0 )
scale = Vector2( 0.1, 0.1 )
z_index = 30
texture = ExtResource( 2 )
offset = Vector2( -18, 0 )

[node name="tip" type="Marker2D" parent="."]
position = Vector2( 12, 0 )
