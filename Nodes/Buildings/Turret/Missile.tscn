[gd_scene load_steps=10 format=2]

[ext_resource path="res://Nodes/Effects/trail.gd" type="Script" id=1]
[ext_resource path="res://Nodes/Player/Weapons/Ranged/Missile.png" type="Texture2D" id=2]
[ext_resource path="res://Nodes/Effects/trail.png" type="Texture2D" id=3]

[sub_resource type="GDScript" id=1]
script/source = "extends Area2D

const SPEED = 400

@onready var tip:= $tip

var dir: Vector2
var dir0: Vector2

var offset := randf_range(0.20, 0.4)
var period := randf_range(20, 30)
var lifetime := randf_range(0, TAU / period)

func _ready() -> void:
	Utils.play_sample(Utils.random_sound(\"res://SFX/Weapons/gun_grenade_launcher_shot\"), self)
	Utils.play_sample(preload(\"res://SFX/Weapons/ROCKET_Launch_Deep_Slow_mono.wav\"), self, true, 1.1)
	Utils.init_player_projectile(self, self, {damage = 10, aspect = Const.Aspects.HEAVY, good = true})
	
	dir = Vector2.RIGHT.rotated(rotation)
	dir0 = dir

func _physics_process(delta: float) -> void:
	lifetime += delta
	dir = dir0.rotated(sin(lifetime * period) * offset)
	rotation = dir.angle()
	var move := dir * SPEED * delta
	var ray := Utils.game.map.pixel_map.rayCastQTDistance(tip.global_position, dir, SPEED * delta, Player.get_weapon_mask(get_meta(\"data\")))
#	var ray := physics.raycast(tip.global_position, tip.global_position + move)
	if ray:
		on_hit()
	else:
		global_position += move

func on_hit():
	var explosion := Const.EXPLOSION.instantiate() as Node2D
	explosion.position = tip.global_position
	explosion.scale = Vector2.ONE * 0.2
	get_parent().call_deferred(\"add_child\", explosion)
	queue_free()
"

[sub_resource type="RectangleShape2D" id=8]
extents = Vector2( 6, 2 )

[sub_resource type="Curve" id=6]
_data = [ Vector2( 0, 0 ), 0.0, 2.82822, 0, 0, Vector2( 1, 1 ), 0.148854, 0.0, 0, 0 ]

[sub_resource type="Gradient" id=7]
offsets = PackedFloat32Array( 0, 0.87057, 1 )
colors = PackedColorArray( 0, 0, 0, 0, 1.24003, 0.159848, 0, 1, 8, 1, 0.109804, 1 )

[sub_resource type="Curve" id=3]
_data = [ Vector2( 0.00759219, 1 ), 0.0, -1.13353, 0, 0, Vector2( 1, 0 ), 0.0137962, 0.0, 0, 0 ]

[sub_resource type="Gradient" id=5]
offsets = PackedFloat32Array( 0, 0.422188, 0.841294, 1 )
colors = PackedColorArray( 1, 1, 1, 0, 1, 1, 1, 0.380392, 0.705882, 0.709804, 0.662745, 0.482353, 1, 1, 1, 0.467734 )

[node name="Missile" type="Area2D"]
script = SubResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( 6, 0 )
shape = SubResource( 8 )

[node name="Smoketrail" type="Line2D" parent="."]
position = Vector2( -7.22224, 0 )
z_index = 20
points = PackedVector2Array( -5.88276, 0.268272, -0.15731, 0.0393295 )
width = 5.0
width_curve = SubResource( 6 )
gradient = SubResource( 7 )
texture = ExtResource( 3 )
texture_mode = 2
joint_mode = 2
begin_cap_mode = 2
end_cap_mode = 2
script = ExtResource( 1 )
max_points = 4
max_random = 0.1
min_distance = 15
fadeout_random = Vector2( 0.1, 0.3 )

[node name="Smoketrail2" type="Line2D" parent="."]
position = Vector2( -7.81149, 0 )
z_index = 9
points = PackedVector2Array( -7.33857, -0.203655, -0.15731, 0.0393295 )
width = 70.0
width_curve = SubResource( 3 )
gradient = SubResource( 5 )
texture = ExtResource( 3 )
texture_mode = 2
joint_mode = 2
begin_cap_mode = 2
end_cap_mode = 2
script = ExtResource( 1 )
max_points = 40
max_random = 0.1
min_distance = 20
fadeout_random = Vector2( 2.1, 4 )

[node name="Sprite2D" type="Sprite2D" parent="."]
position = Vector2( 6.5785, 0 )
scale = Vector2( 0.1, 0.2 )
z_index = 30
texture = ExtResource( 2 )

[node name="tip" type="Marker2D" parent="."]
position = Vector2( 12, 0 )
